import AsyncStorage from '@react-native-async-storage/async-storage';

async function read(k){try{const v=await AsyncStorage.getItem(k);return v?JSON.parse(v):null}catch(e){return null}}
async function write(k,v){try{await AsyncStorage.setItem(k,JSON.stringify(v))}catch(e){}}

export async function getSavedPrograms(){return (await read('saved_programs_v1'))||[]}
export async function savePrograms(list){await write('saved_programs_v1',list||[])}

export async function getActive(){return await read('active_program_v1')}
export async function getPointer(){return await read('current_program_v1')}
export async function setPointer(ptr){await write('current_program_v1',ptr)}

export async function startProgramById(programId){
  const list=await getSavedPrograms();
  const prog=list.find(p=>String(p.id)===String(programId));
  if(!prog) return null;
  const active={id:prog.id,name:prog.name,weeks:prog.weeks,days:prog.days,currentWeek:1,currentDay:1,dayTemplates:{}};
  let tpls=(await read('day_templates_v1'))||[];
  tpls=tpls.filter(t=>!String(t.id).startsWith(`tpl_${prog.id}_`));
  for(let d=1; d<=prog.days; d++){
    const exs=(((prog.plan||{})['1']||{})[String(d)]||[]);
    const id=`tpl_${prog.id}_1_${d}`;
    active.dayTemplates[String(d)]=id;
    tpls.push({id,name:`${prog.name} W1D${d}`,exercises:exs});
  }
  await write('day_templates_v1',tpls);
  await write('active_program_v1',active);
  await write('current_program_v1',{programId:prog.id,week:1,day:1});
  return active;
}

export async function stopActive(){
  await AsyncStorage.removeItem('active_program_v1');
  await AsyncStorage.removeItem('current_program_v1');
}

export async function getDayExercises({programId,programName,week,day}){
  const list=await getSavedPrograms();
  const prog=list.find(p=>String(p.id)===String(programId) || p.name===programName);
  const w=String(week||1), d=String(day||1);
  let arr=[];
  if(prog && prog.plan && prog.plan[w] && Array.isArray(prog.plan[w][d])) arr=prog.plan[w][d];
  if(!arr.length){
    const active=await getActive();
    const tpls=(await read('day_templates_v1'))||[];
    const tplId=active?.dayTemplates?.[d];
    if(tplId){const tpl=tpls.find(t=>t.id===tplId); if(tpl&&Array.isArray(tpl.exercises)) arr=tpl.exercises}
  }
  return arr;
}

export async function advanceAfterFinish(){
  const active=await getActive();
  if(!active) return null;
  const ptr=await getPointer()||{programId:active.id,week:active.currentWeek||1,day:active.currentDay||1};
  let day=Number(ptr.day||1)+1;
  const max=Number(active.days||1);
  if(day>max) day=1;
  const next={programId:active.id,week:1,day};
  await setPointer(next);
  await write('active_program_v1',{...active,currentDay:day});
  return next;
}

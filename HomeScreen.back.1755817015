import React,{useEffect,useMemo,useState} from 'react';
import {View,Text,Pressable,FlatList,Alert} from 'react-native';
import {useNavigation} from '@react-navigation/native';
import {theme} from '../constants/theme';
import AsyncStorage from '@react-native-async-storage/async-storage';
import {getActive,getDayExercises,startProgramById,stopActive} from '../utils/programState';

export default function HomeScreen(){
  const nav=useNavigation();
  const [active,setActive]=useState(null);
  const [preview,setPreview]=useState([]);

  async function refresh(){
    const a=await getActive();
    setActive(a);
    if(a){const arr=await getDayExercises({programId:a.id,week:a.currentWeek,day:a.currentDay});setPreview(arr.slice(0,3))}
    else setPreview([]);
  }

  useEffect(()=>{const unsub=nav.addListener('focus',refresh);refresh();return unsub},[nav]);

  function startEmpty(){nav.navigate('Workout',{mode:'empty'})}
  async function onStartProgram(){
    if(!active){Alert.alert('No active program','Start one from Programs tab');return}
    nav.navigate('Workout',{mode:'program',programId:active.id,programName:active.name,week:active.currentWeek,day:active.currentDay})
  }
  async function onStop(){await stopActive();setActive(null);setPreview([])}

  return(
    <View style={{flex:1,backgroundColor:theme.bg,padding:16}}>
      {active?(
        <View style={{backgroundColor:theme.card,borderRadius:16,padding:16,marginBottom:16}}>
          <View style={{flexDirection:'row',justifyContent:'space-between',alignItems:'center'}}>
            <Text style={{color:theme.text,fontSize:17,fontWeight:'700'}}>{active.name} â€¢ Week {active.currentWeek} Day {active.currentDay}</Text>
            <View style={{flexDirection:'row'}}>
              <Pressable onPress={onStop} style={{backgroundColor:'#1B2733',paddingHorizontal:14,paddingVertical:10,borderRadius:12,marginRight:8}}>
                <Text style={{color:theme.text,fontWeight:'700'}}>Stop</Text>
              </Pressable>
              <Pressable onPress={onStartProgram} style={{backgroundColor:theme.accent,paddingHorizontal:16,paddingVertical:10,borderRadius:12}}>
                <Text style={{color:'#fff',fontWeight:'800'}}>Start</Text>
              </Pressable>
            </View>
          </View>
          <FlatList
            data={preview}
            keyExtractor={(_,i)=>String(i)}
            style={{marginTop:12}}
            renderItem={({item})=>(
              <View style={{flexDirection:'row',justifyContent:'space-between',alignItems:'center',paddingVertical:8}}>
                <Text style={{color:theme.text,flex:1,marginRight:8}} numberOfLines={1}>{item?.name||'Exercise'}</Text>
                <Text style={{color:theme.textDim}}>{Array.isArray(item?.sets)?item.sets.length:(item?.targetSets||0)} sets</Text>
              </View>
            )}
            ItemSeparatorComponent={()=> <View style={{height:1,backgroundColor:theme.border}}/>}
          />
        </View>
      ):null}

      <Pressable onPress={startEmpty} style={{alignSelf:'flex-start',backgroundColor:theme.accent,borderRadius:12,paddingVertical:12,paddingHorizontal:16}}>
        <Text style={{color:'#fff',fontWeight:'800'}}>Start Empty Workout</Text>
      </Pressable>
    </View>
  )
}

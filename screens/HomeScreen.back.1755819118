import React,{useEffect,useState} from 'react';
import {View,Text,Pressable,FlatList} from 'react-native';
import {useNavigation} from '@react-navigation/native';
import {theme} from '../constants/theme';
import {getActive,getDayExercises,navigateDay,startProgramById,getSavedPrograms} from '../utils/programState';

export default function HomeScreen(){
  const nav=useNavigation();
  const [active,setActive]=useState(null);
  const [preview,setPreview]=useState([]);

  async function refresh(){
    const a=await getActive();
    setActive(a||null);
    if(a){const arr=await getDayExercises({programId:a.id,week:a.currentWeek,day:a.currentDay});setPreview(arr.slice(0,3))}else setPreview([]);
  }
  useEffect(()=>{const unsub=nav.addListener('focus',refresh);refresh();return unsub},[nav]);

  async function startFromHome(){
    if(!active){const all=await getSavedPrograms(); if(all[0]){await startProgramById(all[0].id); await refresh();} return}
    nav.navigate('Workout',{mode:'program',programId:active.id,programName:active.name,week:active.currentWeek,day:active.currentDay})
  }
  async function prev(){const p=await navigateDay(-1); if(p){await refresh()}}
  async function next(){const p=await navigateDay(1); if(p){await refresh()}}

  function startEmpty(){nav.navigate('Workout',{mode:'empty'})}

  return(
    <View style={{flex:1,backgroundColor:theme.bg,padding:16}}>
      {active?(
        <View style={{backgroundColor:theme.card,borderRadius:16,padding:16,marginBottom:16}}>
          <View style={{flexDirection:'row',justifyContent:'space-between',alignItems:'center',marginBottom:6}}>
            <Text style={{color:theme.text,fontSize:17,fontWeight:'700'}}>{active.name} • Week {active.currentWeek} Day {active.currentDay}</Text>
            <View style={{flexDirection:'row',gap:8}}>
              <Pressable onPress={prev} style={{backgroundColor:'#1B2733',paddingHorizontal:12,paddingVertical:8,borderRadius:10}}><Text style={{color:theme.text,fontWeight:'700'}}>◀︎</Text></Pressable>
              <Pressable onPress={next} style={{backgroundColor:'#1B2733',paddingHorizontal:12,paddingVertical:8,borderRadius:10}}><Text style={{color:theme.text,fontWeight:'700'}}>▶︎</Text></Pressable>
              <Pressable onPress={startFromHome} style={{backgroundColor:theme.accent,paddingHorizontal:16,paddingVertical:10,borderRadius:12}}>
                <Text style={{color:'#fff',fontWeight:'800'}}>Start</Text>
              </Pressable>
            </View>
          </View>
          <FlatList
            data={preview}
            keyExtractor={(_,i)=>String(i)}
            style={{marginTop:4}}
            renderItem={({item})=>(
              <View style={{flexDirection:'row',justifyContent:'space-between',alignItems:'center',paddingVertical:8}}>
                <Text style={{color:theme.text,flex:1,marginRight:8}} numberOfLines={1}>{item?.name||'Exercise'}</Text>
                <Text style={{color:theme.textDim}}>{Array.isArray(item?.sets)?item.sets.length:(item?.targetSets||0)} sets</Text>
              </View>
            )}
            ItemSeparatorComponent={()=> <View style={{height:1,backgroundColor:theme.border}}/>}
          />
        </View>
      ):null}

      <Pressable onPress={startEmpty} style={{alignSelf:'flex-start',backgroundColor:theme.accent,borderRadius:12,paddingVertical:12,paddingHorizontal:16}}>
        <Text style={{color:'#fff',fontWeight:'800'}}>Start Empty Workout</Text>
      </Pressable>
    </View>
  )
}
